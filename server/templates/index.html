{% extends "base.html" %}

{% block scripts %}
{{super()}}
 
<script>

    var btn_reboot = document.getElementById("btn_reboot_bbb");
    var btn_switch = document.getElementById("btn_switch_bbb");

    console.log(btn_reboot);
    console.log(btn_switch);

    var bbb_configured_selected = null;
    var bbb_unconfigured_selected = null;

    var active_sector_val = null;
    
    $("#btn_reboot_bbb").click( function() {
        console.log("id="+bbb_configured_selected);
        $.post(
            '{{ reboot_bbb_url }}',
            { bbb_ip: bbb_configured_selected, bbb_sector:active_sector_val}
        ).done(function(data){
            console.log(data); 
        });
    });
    
    $("#btn_switch_bbb").click( function() {
        console.log("id="+bbb_configured_selected + "id2="+bbb_unconfigured_selected);

        if(bbb_configured_selected != null && bbb_unconfigured_selected != null){
            $.post(
                '{{ switch_bbb_url }}',
                { c_bbb_ip: bbb_configured_selected, c_bbb_sector:active_sector_val,
                    u_bbb_ip: bbb_unconfigured_selected, u_bbb_sector:active_sector_val}
            ).done(function(data){
                console.log(data); 
            });
        }
    });
    
    function refresh_bbbs() {
        var current_sector_val = $('#current_sector').val();
        console.log(current_sector_val);
        
        if(active_sector_val != current_sector_val ){
            active_sector_val = current_sector_val;
        
            bbb_configured_selected = null;
            bbb_unconfigured_selected = null;

            btn_reboot.disabled = true;
            btn_switch.disabled = true;
        }
        
        $.post( '{{ refresh_url }}', { sector: current_sector_val})
            .done(function( data ) {
                
                $('#active_bbbs').html(data)
                
                $("#table_configured").on('click', 'tr', function() {
    
                    var row_val = $(this).find('td:first').text();
                    
                    if(row_val == bbb_configured_selected){
                        bbb_configured_selected = null;
                    }else{ 
                        bbb_configured_selected = row_val;
                    }
                    console.log(bbb_configured_selected);
                    btn_reboot.disabled = (bbb_configured_selected == null);
                    /*if(btn_reboot.disabled == false){
                        btn_reboot.children().first().text = "Reboot BBB: "+ bbb_configured_selected;
                    }else{
                        btn_reboot.children().first().text = "Reboot BBB";
                    }*/

                    btn_switch.disabled = (bbb_unconfigured_selected == null || bbb_configured_selected == null);
                    /*
                    if(btn_switch){
                        btn_switch.text("Switch Selected BBBs: " + bbb_configured_selected + " " + bbb_unconfigured_selected);
                    }else{
                        btn_switch.text("Switch Selected BBBs");
                    }
                    */

                });

                $("#table_unconfigured").on('click', 'tr', function() {
                    var row_val = $(this).find('td:first').text()

                    if(row_val == bbb_unconfigured_selected){
                        bbb_unconfigured_selected = null;
                    }else{
                        bbb_unconfigured_selected = row_val;
                    }

                });

        });
    }

    refresh_bbbs();

    setInterval(function () {
        refresh_bbbs()
    }, 2000);
    
 </script>
{% endblock %}

{% block content %}
{{super()}}

<div class="container">
    <div><strong><h3>Current Sector</h3></strong><br></div>
    <div class="form-group ">
        <div class="selectContainer">
            <select class="form-control" name="size" id="current_sector">
                {% for sector in sectors %}
                    <option value={{sector}}>{{sector}}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div><br>

<div class="container" id="active_bbbs">
    <h2>Current Active BBBBs</h2><br>
    <table class="table table-hover">
        <h3>Configured</h3>
        <thead class="thead-dark">
        <tr>
            <th scope="col">IP Address</th>
            <th scope="col">Name</th>
            <th scope="col">Type</th>
            <th scope="col">Sector</th>
            <th scope="col">PV Prefix</th>
            <th scope="col">State</th>
        </tr>
        </thead>
    </table>
    <br>
    <table class="table table-hover">
        <h3>Not Configured</h3>
        <thead class="thead-dark">
        <tr>
            <th scope="col">IP Address</th>
            <th scope="col">Name</th>
            <th scope="col">Type</th>
            <th scope="col">Sector</th>
            <th scope="col">PV Prefix</th>
            <th scope="col">State</th>
        </tr>
        </thead>
    </table>
 
</div>
<div class="container">
    <button id="btn_reboot_bbb" type="button" class="btn btn-primary" disabled>Reboot BBB</button>
    <button id="btn_switch_bbb" type="button" class="btn btn-primary" disabled>Switch Selected BBBs</button>
</div>

{% endblock %}